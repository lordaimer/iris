name: Update Chocolatey Package

on:
  push:
    tags:
      - "v*"

jobs:
  update-chocolatey:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: dist/chocolatey
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Chocolatey package
        shell: pwsh
        run: |
          $version = $env:GITHUB_REF_NAME -replace '^v', ''
          $tag = $env:GITHUB_REF_NAME
          
          # Download the Windows executable
          $downloadUrl = "https://github.com/lordaimer/iris/releases/download/$tag/iris-windows-amd64.exe"
          Invoke-WebRequest -Uri $downloadUrl -OutFile "iris-windows-amd64.exe"
          
          # Calculate SHA256 checksum
          $checksum = (Get-FileHash -Path "iris-windows-amd64.exe" -Algorithm SHA256).Hash.ToLower()
          
          # Update nuspec (chocolatey/iris.nuspec)
          $nuspecPath = "chocolatey/iris.nuspec"
          $nuspecContent = Get-Content $nuspecPath -Raw
          $nuspecContent = $nuspecContent -replace '<id>iris-cli</id>\s*<version>[\d\.]+</version>', "<id>iris-cli</id>`r`n    <version>$version</version>"
          Set-Content -Path $nuspecPath -Value $nuspecContent -NoNewline
          
          # Update install script (chocolatey/tools/chocolateyinstall.ps1)
          $installPath = "chocolatey/tools/chocolateyinstall.ps1"
          $installContent = Get-Content $installPath -Raw
          $installContent = $installContent -replace "checksum64\s*=\s*'[a-fA-F0-9]{64}'", "checksum64     = '$checksum'"
          Set-Content -Path $installPath -Value $installContent -NoNewline
          
          # Cleanup
          Remove-Item "iris-windows-amd64.exe"
          
          # Commit and push
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add $nuspecPath $installPath
          git commit -m "chore[chocolatey]: update Chocolatey package to $tag"
          git push
