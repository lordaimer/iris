name: Update Chocolatey Package

on:
  workflow_run:
    workflows: ["Release"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name (e.g. v1.3.4)'
        required: true

permissions:
  contents: write

jobs:
  update-chocolatey:
    runs-on: windows-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: dist/chocolatey
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Chocolatey package
        shell: pwsh
        env:
          TAG_NAME: ${{ github.event.workflow_run.head_branch || inputs.tag_name }}
        run: |
          $tag = $env:TAG_NAME
          if (-not $tag.StartsWith("v")) {
            Write-Warning "Trigger branch/tag '$tag' does not start with 'v'. Skipping Chocolatey update."
            exit 0
          }
          $version = $tag -replace '^v', ''
          
          # Download the Windows executable
          $downloadUrl = "https://github.com/lordaimer/iris/releases/download/$tag/iris-windows-amd64.exe"
          Write-Host "Downloading from: $downloadUrl"
          
          # Add a small retry loop for resilience
          $maxRetries = 5
          $retryCount = 0
          $downloaded = $false
          
          while (-not $downloaded -and $retryCount -lt $maxRetries) {
            try {
              Invoke-WebRequest -Uri $downloadUrl -OutFile "iris-windows-amd64.exe" -ErrorAction Stop
              $downloaded = $true
            } catch {
              Write-Host "Attempt $($retryCount + 1) failed: $_"
              Start-Sleep -Seconds 10
              $retryCount++
            }
          }
          
          if (-not $downloaded) {
             throw "Failed to download asset after $maxRetries attempts."
          }
          
          # Calculate SHA256 checksum
          $checksum = (Get-FileHash -Path "iris-windows-amd64.exe" -Algorithm SHA256).Hash.ToLower()
          
          # Update nuspec (chocolatey/iris.nuspec)
          $nuspecPath = "chocolatey/iris.nuspec"
          $nuspecContent = Get-Content $nuspecPath -Raw
          $nuspecContent = $nuspecContent -replace '<id>iris-cli</id>\s*<version>[\d\.]+</version>', "<id>iris-cli</id>`r`n    <version>$version</version>"
          $nuspecContent = $nuspecContent -replace '<releaseNotes>.*?</releaseNotes>', "<releaseNotes>https://github.com/lordaimer/iris/releases/tag/$tag</releaseNotes>"
          Set-Content -Path $nuspecPath -Value $nuspecContent -NoNewline
          
          # Update install script (chocolatey/tools/chocolateyinstall.ps1)
          $installPath = "chocolatey/tools/chocolateyinstall.ps1"
          $installContent = Get-Content $installPath -Raw
          $installContent = $installContent -replace "checksum64\s*=\s*'[a-fA-F0-9]{64}'", "checksum64     = '$checksum'"
          $installContent = $installContent -replace "\`$version\s*=\s*'[\d\.]+'", "`$version = '$version'"
          Set-Content -Path $installPath -Value $installContent -NoNewline
          
          # Cleanup
          Remove-Item "iris-windows-amd64.exe"
          
          # Commit and push
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add $nuspecPath $installPath
          git commit -m "chore[chocolatey]: update Chocolatey package to $tag"
          git push
